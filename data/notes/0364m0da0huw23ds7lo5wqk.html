<h1 id="concurrency-and-parallelism">Concurrency and Parallelism<a aria-hidden="true" class="anchor-heading icon-link" href="#concurrency-and-parallelism"></a></h1>
<h1 id="concurrency-models-in-python">Concurrency Models in Python<a aria-hidden="true" class="anchor-heading icon-link" href="#concurrency-models-in-python"></a></h1>
<p>Chapter 19 from "Fluent Python"</p>
<p>Concurrency is about dealing with multiple things at once.</p>
<p>Parallelism is about doing multiple things at once.</p>
<p>Concurrency is about structure, Parallelism is about execution.</p>
<p>A CPU with 4 cores can run 4 processes in parallel but 100s processes concurrently. </p>
<h1 id="old-notes">Old notes<a aria-hidden="true" class="anchor-heading icon-link" href="#old-notes"></a></h1>
<ul>
<li>concurrent, multithreaded programming, <a href="https://leetcode.com/problems/web-crawler-multithreaded/">web crawler</a></li>
</ul>
<pre class="language-python"><code class="language-Python"><span class="token comment"># simple DFS</span>
<span class="token keyword">class</span> <span class="token class-name">Solution</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">crawl</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> start<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> parser<span class="token punctuation">:</span> <span class="token string">'HtmlParser'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        hostname <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        visited<span class="token punctuation">,</span>stack<span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span>start<span class="token punctuation">]</span>
        <span class="token keyword">while</span> stack<span class="token punctuation">:</span>
            s <span class="token operator">=</span> stack<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> u <span class="token keyword">in</span> parser<span class="token punctuation">.</span>getUrls<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> u <span class="token keyword">not</span> <span class="token keyword">in</span> visited <span class="token keyword">and</span> hostname<span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token operator">==</span> hostname<span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    visited<span class="token punctuation">.</span>add<span class="token punctuation">(</span>u<span class="token punctuation">)</span>
                    stack<span class="token punctuation">.</span>append<span class="token punctuation">(</span>u<span class="token punctuation">)</span>
        <span class="token keyword">return</span> visited

<span class="token comment"># concurrent DFS</span>
<span class="token keyword">from</span> concurrent <span class="token keyword">import</span> futures
<span class="token keyword">class</span> <span class="token class-name">Solution</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">crawl</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> parser<span class="token punctuation">:</span> <span class="token string">'HtmlParser'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        hostname <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        visited <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
            tasks <span class="token operator">=</span> <span class="token punctuation">[</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>parser<span class="token punctuation">.</span>getUrls<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token keyword">while</span> tasks<span class="token punctuation">:</span>
                neigh <span class="token operator">=</span> tasks<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> u <span class="token keyword">in</span> neigh<span class="token punctuation">:</span>
                    <span class="token keyword">if</span> u <span class="token keyword">not</span> <span class="token keyword">in</span> visited <span class="token keyword">and</span> hostname<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">==</span> hostname<span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">:</span>
                        visited<span class="token punctuation">.</span>add<span class="token punctuation">(</span>u<span class="token punctuation">)</span>
                        tasks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>parser<span class="token punctuation">.</span>getUrls<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> visited
</code></pre>
<h1 id="deadlocks-and-how-to-properly-acquire-release-locks">Deadlocks and how to properly acquire release locks<a aria-hidden="true" class="anchor-heading icon-link" href="#deadlocks-and-how-to-properly-acquire-release-locks"></a></h1>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> threading <span class="token keyword">import</span> Lock
</code></pre>
<p>Common examples of the cause of threading deadlocks include:</p>
<ul>
<li>A thread that waits on itself (acquires itself twice releases once and waits for itself)</li>
<li>Threads that wait on each other (e.g. A waits on B, B waits on A).</li>
<li>Thread that fails to release a resource (e.g. mutex lock, semaphore, barrier, condition, event, etc.).</li>
<li>Threads that acquire mutex locks in different orders (e.g. fail to perform lock ordering).</li>
</ul>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> threading <span class="token keyword">import</span> Lock
lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># deadlock</span>

<span class="token comment"># no deadlock I think</span>
lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span> 
lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
<ul>
<li>
<p><a href="https://leetcode.com/problems/print-in-order/">Print Order</a></p>
</li>
<li>
<p><a href="https://leetcode.com/problems/fizz-buzz-multithreaded/">FizzBuzz</a></p>
</li>
</ul>
<p>malko e mazalo...</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> threading <span class="token keyword">import</span> Lock
<span class="token keyword">class</span> <span class="token class-name">FizzBuzz</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>n <span class="token operator">=</span> n
        self<span class="token punctuation">.</span>finish <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>fizz_lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>buzz_lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fizzbuzz_lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>main <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fizz_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>buzz_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fizzbuzz_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># printFizz() outputs "fizz"</span>
    <span class="token keyword">def</span> <span class="token function">fizz</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> printFizz<span class="token punctuation">:</span> <span class="token string">'Callable[[], None]'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>fizz_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>finish<span class="token punctuation">:</span> <span class="token keyword">return</span>
            printFizz<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>main<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># printBuzz() outputs "buzz"</span>
    <span class="token keyword">def</span> <span class="token function">buzz</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> printBuzz<span class="token punctuation">:</span> <span class="token string">'Callable[[], None]'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>buzz_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>finish<span class="token punctuation">:</span> <span class="token keyword">return</span>
            printBuzz<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>main<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># printFizzBuzz() outputs "fizzbuzz"</span>
    <span class="token keyword">def</span> <span class="token function">fizzbuzz</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> printFizzBuzz<span class="token punctuation">:</span> <span class="token string">'Callable[[], None]'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>fizzbuzz_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>finish<span class="token punctuation">:</span> <span class="token keyword">return</span>
            printFizzBuzz<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>main<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
    <span class="token comment"># printNumber(x) outputs "x", where x is an integer.</span>
    <span class="token keyword">def</span> <span class="token function">number</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> printNumber<span class="token punctuation">:</span> <span class="token string">'Callable[[int], None]'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>main<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> i <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>fizz_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> i <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">and</span> i <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>buzz_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> i <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> i <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>fizzbuzz_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                printNumber<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>main<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>main<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>finish <span class="token operator">=</span> <span class="token boolean">True</span>
        self<span class="token punctuation">.</span>buzz_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fizz_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fizzbuzz_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre>
<p>GOAL: Run only one thread at a time!!!!!</p>
<p>Racing conditions are dangerous.</p>
<h1 id="native-coroutines">Native Coroutines<a aria-hidden="true" class="anchor-heading icon-link" href="#native-coroutines"></a></h1>
<p>Python has three ways to run things concurrently</p>
<ul>
<li>coroutines (classic and native)</li>
<li>threads</li>
<li>processes</li>
</ul>
<p>Native coroutines use asyncio library using <code>async def</code> and <code>await</code> syntax</p>
<ul>
<li><code>asyncio</code> is a library that allows the USER to manually create an event loop (with ONE THREAD) and schedule tasks to run concurrently</li>
<li>Allows YOU to multitask with functions!</li>
<li>asyncio is Python’s <strong>standard library</strong></li>
<li><strong>Run time of concurrently ran functions = Run time of slowest function</strong>, if you schedule the tasks to run in the background!</li>
</ul>
<h2 id="creating-background-task">Creating Background Task<a aria-hidden="true" class="anchor-heading icon-link" href="#creating-background-task"></a></h2>
<p>say you have two functions one that takes 10 seconds and one that takes 5 seconds, how can you run them concurrently?</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Starting slow"</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Ended slow"</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">calc_that_does_not_wait_slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">await</span> calc_that_does_not_wait_slow<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">await</span> slow<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> time
<span class="token keyword">print</span><span class="token punctuation">(</span>start<span class="token operator">:=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> main<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>end<span class="token operator">:=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">)</span>

<span class="token comment"># takes 15 seconds</span>
<span class="token comment"># even if you swap </span>
<span class="token comment">#       await calc_that_does_not_wait_slow()</span>
<span class="token comment">#       await slow()</span>
<span class="token comment"># it will take 15 seconds</span>
</code></pre>
<p><strong>You need to make them one as background task!</strong> Currently you are running code sequentially.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'starting slow'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'ended slow'</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">calc_that_does_not_wait_slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    slow_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>slow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token keyword">await</span> calc_that_does_not_wait_slow<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Outside main:</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>start<span class="token operator">:=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> main<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>end<span class="token operator">:=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">)</span>
<span class="token comment"># Prints 5 seconds only! And 5 seconds after prints ended slow!</span>
<span class="token comment">#  How it runs: </span>
<span class="token comment">#</span>
<span class="token comment">#      slow() is started in the background (will take 10 seconds).</span>
<span class="token comment">#      You immediately start and await calc_that_does_not_wait_slow() (waits 5 seconds, then prints 1).</span>
<span class="token comment">#      When calc_that_does_not_wait_slow() is done (after 5 seconds), main() returns—even if slow() is still running!</span>
<span class="token comment">#      The program ends; slow() may be cancelled or left unfinished.</span>
     
</code></pre>
<p><strong>Lets await the task and the calculation now.</strong></p>
<ul>
<li>await the slow first and then the other -> 15 seconds - sad</li>
</ul>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Starting slow"</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Ended slow"</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">calc_that_does_not_wait_slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      slow_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>slow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># background task</span>
      <span class="token keyword">await</span> slow_task
      <span class="token keyword">await</span> calc_that_does_not_wait_slow<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> time
<span class="token keyword">print</span><span class="token punctuation">(</span>start<span class="token operator">:=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> main<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>end<span class="token operator">:=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">)</span>

<span class="token comment"># Output</span>
<span class="token comment"># 1754464873.7352946</span>
<span class="token comment"># Starting slow</span>
<span class="token comment"># Ended slow</span>
<span class="token comment"># 1</span>
<span class="token comment"># 1754464888.7525644</span>
<span class="token comment"># 15.017269849777222</span>
</code></pre>
<ul>
<li>await the  slow after and it takes 10 seconds</li>
</ul>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Starting slow"</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Ended slow"</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">calc_that_does_not_wait_slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      slow_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>slow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">await</span> calc_that_does_not_wait_slow<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">await</span> slow_task
<span class="token keyword">import</span> time
<span class="token keyword">print</span><span class="token punctuation">(</span>start<span class="token operator">:=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> main<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>end<span class="token operator">:=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">)</span>

<span class="token comment"># Output </span>
<span class="token comment"># 1754464849.4491456</span>
<span class="token comment"># Starting slow</span>
<span class="token comment"># 1</span>
<span class="token comment"># Ended slow</span>
<span class="token comment"># 1754464859.4551563</span>
<span class="token comment"># 10.00601077079773</span>
</code></pre>
<h2 id="background-tasks-are-confusing---just-use-gather">Background tasks are confusing - just use gather!<a aria-hidden="true" class="anchor-heading icon-link" href="#background-tasks-are-confusing---just-use-gather"></a></h2>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Starting slow"</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Ended slow"</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">calc_that_does_not_wait_slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Both coroutines start at once; don't wait for one to finish before the other</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>slow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> calc_that_does_not_wait_slow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># will run for 10 seconds as well</span>
</code></pre>
<h3 id="summary">Summary<a aria-hidden="true" class="anchor-heading icon-link" href="#summary"></a></h3>
<p><strong>Concurrent async functions:</strong></p>
<ul>
<li>If you want two async functions (coroutines) to run simultaneously, you must schedule them to run at the same time.</li>
<li>await-ing one after the other causes them to run sequentially, so the total run time is the sum of both delays.
</li>
</ul>
<p><strong>Background tasks with create_task:</strong></p>
<ul>
<li>Using asyncio.create_task(coro()) starts a coroutine in the background.</li>
<li>If you don't later await the task, your program may exit before the background task finishes.</li>
<li>If you start the slow task in the background and only await the fast task, the program finishes after the fast task—even if the slow one hadn't finished yet (the slow one is cancelled or left unfinished).</li>
</ul>