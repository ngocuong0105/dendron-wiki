<h1 id="memory-management">Memory Management<a aria-hidden="true" class="anchor-heading icon-link" href="#memory-management"></a></h1>
<h1 id="memory-management-1">Memory Management<a aria-hidden="true" class="anchor-heading icon-link" href="#memory-management-1"></a></h1>
<pre class="language-python"><code class="language-python"><span class="token keyword">del</span> df <span class="token comment"># does not release memory to the OS</span>
gc<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># still does not release memory</span>
</code></pre>
<ul>
<li>Python objects have high-water mark. It is expensive to pull memory from OS so Python interpreter reserves it for future use so in <code>htop</code> it looks like memory is being used.</li>
<li>So in theory when you continue working in the python process you should be able to reclaim this memory with other python objects.</li>
<li>Yes but unfortunately mostly no... In practice data is fragmented and is not usable unless you close the process (close the interactive terminal)</li>
<li>Often you will have a <em>data leak or fragmentation</em>, meaning the objects are still in memory but not accessible to you. They are scattered around and not usable.</li>
</ul>
<p><strong>Hacks</strong></p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> psutil

<span class="token keyword">def</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    process <span class="token operator">=</span> psutil<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> process<span class="token punctuation">.</span>memory_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">20</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">huge_intermediate_calc</span><span class="token punctuation">(</span>something<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    huge_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> some_aggregate

<span class="token keyword">import</span> multiprocessing

result <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Pool<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>huge_intermediate_calc<span class="token punctuation">,</span> <span class="token punctuation">[</span>something_<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>


<span class="token keyword">with</span> multiprocessing<span class="token punctuation">.</span>Pool<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pool<span class="token punctuation">:</span> 
    result <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>huge_intermediate_calc<span class="token punctuation">,</span> <span class="token punctuation">[</span>something<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># However in a ipython environment (like jupyter notebook) I found that you need to .close() and .join() or .terminate() the pool to get rid of the spawned process.</span>

<span class="token comment"># Tested example:</span>
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span>TRAIN_DATA_PATH<span class="token punctuation">)</span>
    <span class="token keyword">return</span> df

<span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures
<span class="token comment"># max_workers = number of CPUs (threads on your machine, e.g 2 threads per core with8 cores is 16)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Number of logical CPUs:"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>cpu_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ProcessPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
    start_usage <span class="token operator">=</span> usage<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Start: '</span><span class="token punctuation">,</span> start_usage<span class="token punctuation">)</span>
    result <span class="token operator">=</span> executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>func<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'End: '</span><span class="token punctuation">,</span> usage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># close process</span>
    executor<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span>wait<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>usage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
<p>"Then the function is executed at a different process. When that process completes, the OS retakes all the resources it used. Python, pandas, the garbage collector"</p>
<ul>
<li>no one can do anything to stop that.</li>
</ul>
<p><strong>Some notes and definitions of the aboe tricks</strong></p>
<ul>
<li>Each process is a separate Python interpreter on your local machine (not remote machines).</li>
<li>ProcessPoolExecutor will not work in the interactive interpreter <a href="https://docs.python.org/3/library/concurrent.futures.html">docs</a></li>
</ul>
<h1 id="tracing-python-memory">Tracing Python Memory<a aria-hidden="true" class="anchor-heading icon-link" href="#tracing-python-memory"></a></h1>
<p><a class="color-tag" style="--tag-color: #fbdd7e;" href="/dendron-wiki/notes/q334c9dkrbs70eq5gujgcb3">#TODO</a></p>
<ul>
<li>python library to trace memory allocations <a href="https://docs.python.org/3/library/tracemalloc.html">tracemalloc</a></li>
</ul>
<h1 id="del-and-garbage-collection">del and Garbage Collection<a aria-hidden="true" class="anchor-heading icon-link" href="#del-and-garbage-collection"></a></h1>
<p>"Objects are never explicitly destroyed; however when they become unreachable hey may be garbage-collected."</p>
<pre class="language-python"><code class="language-python"><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># returns true</span>
x <span class="token keyword">and</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> usually mean the same thing
<span class="token keyword">del</span> x <span class="token comment"># this is a statement not a function</span>
<span class="token keyword">del</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment"># would do the same thing</span>


<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token comment"># tuple</span>
</code></pre>
<ul>
<li><code>del</code> deletes the reference, not the object</li>
</ul>
<pre class="language-python"><code class="language-python">l1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment"># l1 reference to the object [1,2]</span>
l2 <span class="token operator">=</span> l1 <span class="token comment"># l2 reference to the object</span>
<span class="token keyword">del</span> l1 <span class="token comment"># deletes reference l1</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>l2<span class="token punctuation">)</span> <span class="token comment"># [1,2]</span>
</code></pre>
<pre class="language-python"><code class="language-python"><span class="token comment"># example of a life of an object</span>
<span class="token keyword">import</span> weakref
<span class="token keyword">def</span> <span class="token function">bye</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'... goodbye my lover'</span><span class="token punctuation">)</span>
ender <span class="token operator">=</span> weakref<span class="token punctuation">.</span>finalize<span class="token punctuation">(</span>s1<span class="token punctuation">,</span> bye<span class="token punctuation">)</span>
ender<span class="token punctuation">.</span>alive <span class="token comment"># True</span>
<span class="token keyword">del</span> s1
ender<span class="token punctuation">.</span>alive <span class="token comment"># True</span>
s2 <span class="token operator">=</span> <span class="token string">''</span> <span class="token comment"># ... goodbye my lover</span>
ender<span class="token punctuation">.</span>alive <span class="token comment"># False</span>
</code></pre>
<p>Objects may be deleted by the garbage collector once they become unreachable! In CPython When the reference count of an object reaches zero, the garbage collector disposes of it. </p>
<h1 id="-vs-is">== vs <code>is</code><a aria-hidden="true" class="anchor-heading icon-link" href="#-vs-is"></a></h1>
<ul>
<li><code>==</code> compares values, <code>is</code> compares if it referencing to the same object</li>
</ul>
<pre class="language-python"><code class="language-python">l1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
l2 <span class="token operator">=</span> l1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token comment"># make copy</span>
l2 <span class="token operator">==</span> l1 <span class="token comment"># true</span>
l1 <span class="token keyword">is</span> l2 <span class="token comment"># false</span>

l3 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>

l3 <span class="token operator">==</span> l2 <span class="token comment"># true</span>
</code></pre>
<p><strong>Garbage Collector</strong></p>
<p>reference-counting - when it becomes zero it is unreachable and collected.</p>
<p>CPython implementation detail: CPython currently uses a reference-counting scheme with (optional) delayed detection of cyclically linked garbage, which collects most objects as soon as they become unreachable,
but is not guaranteed to collect garbage containing circular references.</p>
<ul>
<li>simple assignment does not create copies - references to the same object</li>
<li>function parameters are passed as aliases, which means the function may change any mutable object received as an argument. Need to make local copy to prevent this.</li>
<li>Using mutable objects as default values for function parameters is dangerous because if parameters are changed in-place, the default value is changed!</li>
</ul>